---
include:
  - 'https://git.scc.kit.edu/m-team/ci-voodoo/raw/master/ci-include/generic-ci.yml'
  - 'https://git.scc.kit.edu/m-team/ci-voodoo/raw/master/ci-include/pipeline-jobs.yml'

variables:
  # These variables are set globally here:
  DOCKER_IMAGE_NAMESPACE: 'marcvs/build'
  DOCKER_IMAGE_NAME: 'pam-ssh-oidc-packaging'
  #TARGET_REPO: 'devel'
  # The following varialbes can be overwritten only in specific targets
  # REPO_BASE
  # REPO_USER
  # REPO_HOST

.deb-before-script: &deb-before-script
  - make get-sources

.rpm-before-script: &rpm-before-script
  - make get-sources
  - make patch-for-rpm
  - ls -la rpm


build-debian-buster:
  extends:
    - .build-debian-buster
    - .on-push-and-master
  before_script:
    - *deb-before-script
  # variables:
  #   REPO_BASE: '/var/www/prerel'

build-debian-bullseye:
  extends:
    - .build-debian-bullseye
    - .on-push-and-master
  before_script:
    - *deb-before-script

build-debian-bookworm:
  extends:
    - .build-debian-bookworm
    - .on-push-and-master
  before_script:
    - *deb-before-script



build-ubuntu-bionic:
  extends:
    - .build-ubuntu-bionic
    - .on-push-and-master
  before_script:
    - *deb-before-script

build-ubuntu-focal:
  extends:
    - .build-ubuntu-focal
    - .on-push-and-master
  before_script:
    - *deb-before-script

build-ubuntu-jammy:
  extends:
    - .build-ubuntu-jammy
    - .on-push-and-master
  before_script:
    - *deb-before-script

build-ubuntu-kinetic:
  extends:
    - .build-ubuntu-kinetic
    - .on-push-and-master
  before_script:
    - *deb-before-script

build-centos-7:
  extends:
    - .build-centos-7
    - .on-push-and-master
  before_script:
    - *rpm-before-script

build-centos-8:
  extends:
    - .build-centos-8
    - .on-push-and-master
  before_script:
    - *rpm-before-script

build-centos-stream:
  extends:
    - .build-centos-stream
    - .on-push-and-master
  before_script:
    - *rpm-before-script


build-rockylinux-8:
  extends:
    - .build-rockylinux-85
    - .never

build-rockylinux-8.5:
  extends:
    - .build-rockylinux-85
    - .on-push-and-master
  before_script:
    - *rpm-before-script



# Fedora container build fails with some GPG issues
#build-fedora-36:
#  extends:
#    - .build-fedora-36
#    - .on-push-and-master
#  before_script:
#    - *rpm-before-script



build-opensuse-leap-15.3:
  extends:
    - .build-opensuse-leap-153
    - .on-push-and-master
  before_script:
    - *rpm-before-script

build-opensuse-leap-15.4:
  extends:
    - .build-opensuse-leap-154
    - .on-push-and-master
  before_script:
    - *rpm-before-script

build-opensuse-leap-15.5:
  extends:
    - .build-opensuse-leap-155
    - .on-push-and-master
  before_script:
    - *rpm-before-script

build-opensuse-tumbleweed:
  extends:
    - .build-opensuse-tumbleweed
    - .on-push-and-master
  allow_failure: true
  before_script:
    - *rpm-before-script

integration-tests:
  stage: build
  variables:
    PLUGIN_REF: main
    AGENT_REF: $CI_COMMIT_REF_NAME
  rules:
    # When this is in, error changes:
    # from: "Reference not found"
    # to:   "No stages / jobs for this pipeline"
    #- if: $CI_PIPELINE_SOURCE != "push" && $CI_PIPELINE_SOURCE != "web"
    #  when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      variables:
        TRIGGER_BRANCH: revitalise
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
      variables:
        TRIGGER_BRANCH: revitalise
  inherit:
    variables: false
  trigger:
    project: m-team/integration/test-ssh-oidc
    branch: $TRIGGER_BRANCH
